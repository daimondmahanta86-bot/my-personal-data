<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daimond's Planner (Ultimate Cloud)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        /* --- ORIGINAL THEME VARIABLES --- */
        :root { --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e); --container-bg: rgba(20, 20, 40, 0.95); --text-color: #e0e0e0; --gold-accent: #ffd700; --saffron: #ff9933; --peacock-green: #00ffcc; --mistake-red: #ff4d4d; --border-color: #444; --profit-green: #2ecc71; --slot-bg: rgba(255,255,255,0.02); --slot-hover: rgba(255,255,255,0.08); --detail-btn-color: #aaa; }
        body.theme-warzone { --bg-gradient: linear-gradient(135deg, #000000, #1a0505, #2c0000); --container-bg: rgba(20, 0, 0, 0.95); --gold-accent: #ff4d4d; --peacock-green: #ff9f43; --text-color: #e0e0e0; --border-color: #550000; }
        body.theme-matrix { --bg-gradient: linear-gradient(135deg, #000000, #0a1a0a, #001100); --container-bg: rgba(0, 20, 0, 0.95); --gold-accent: #00ff00; --peacock-green: #00ff00; --mistake-red: #ff0055; --text-color: #00dd00; --border-color: #004400; }
        body.theme-zen { --bg-gradient: linear-gradient(135deg, #f5f7fa, #c3cfe2); --container-bg: rgba(255, 255, 255, 0.95); --text-color: #333; --gold-accent: #2980b9; --peacock-green: #27ae60; --border-color: #ccc; --slot-bg: rgba(0,0,0,0.02); --slot-hover: rgba(0,0,0,0.05); --detail-btn-color: #555; }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-gradient); background-attachment: fixed; margin: 0; padding: 10px; color: var(--text-color); min-height: 100vh; overflow-x: hidden; transition: background 0.5s ease; }
        .container { max-width: 1100px; margin: 0 auto; background: var(--container-bg); padding: 20px; border-radius: 15px; box-shadow: 0 0 10px var(--gold-accent); border: 1px solid var(--gold-accent); backdrop-filter: blur(10px); }

        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--gold-accent); }
        #login-box { border: 2px solid var(--gold-accent); padding: 30px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; background: rgba(20,20,20,0.95); }
        .login-input { font-size: 20px; padding: 10px; text-align: center; border-radius: 10px; border: 1px solid #555; background: #222; color: white; margin-top: 20px; letter-spacing: 5px; width: 80%; }
        .login-btn { margin-top: 20px; padding: 10px 30px; font-size: 18px; background: var(--gold-accent); color: black; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; }

        /* HEADER */
        header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--gold-accent); padding-bottom: 15px; position: relative; }
        .user-name { font-size: 1.2rem; color: var(--peacock-green); letter-spacing: 1px; text-transform: uppercase; font-weight: bold; }
        .rank-badge { position: absolute; right: 0; top: 0; background: rgba(255, 215, 0, 0.1); border: 1px solid var(--gold-accent); padding: 2px 10px; border-radius: 20px; font-size: 0.8rem; color: var(--gold-accent); }

        /* CONTROLS */
        .top-controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .date-nav { display: flex; align-items: center; gap: 5px; width: 100%; justify-content: center; margin-bottom: 10px; }
        .btn { background: transparent; color: var(--gold-accent); border: 1px solid var(--gold-accent); padding: 8px 12px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        input[type="date"] { background: rgba(255,255,255,0.1); color: var(--text-color); border: 1px solid var(--border-color); padding: 5px; border-radius: 5px; flex-grow: 1; text-align: center; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .score-board, .pnl-board, .brahmacharya-board, .screen-time-board { text-align: center; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 10px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100px; }
        .pnl-board { border-color: var(--peacock-green); }
        .score-val { font-size: 1.8rem; font-weight: bold; color: var(--peacock-green); }
        .score-label { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; }
        .pnl-input { background: transparent; border: none; border-bottom: 1px solid #555; color: white; font-size: 1.2rem; text-align: center; width: 100%; }
        .mindset-select { background: #222; color: white; border: 1px solid #444; padding: 5px; width: 100%; border-radius: 5px; margin-top: 5px; }

        /* SCHEDULE LIST */
        .schedule-grid { border: 1px solid var(--border-color); margin-bottom: 30px; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); }
        .time-slot { display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding: 8px; flex-wrap: wrap; gap: 5px; }
        .time-label { width: 70px; color: var(--gold-accent); font-weight: bold; font-size: 0.8rem; text-align: center; }
        .cat-select { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; }
        .task-input { flex: 1; border: none; padding: 8px; background: transparent; color: var(--text-color); font-size: 1rem; border-bottom: 1px dotted #444; min-width: 150px; }
        .task-done { text-decoration: line-through; opacity: 0.5; }
        .action-group { display: flex; gap: 5px; margin-left: auto; }
        .done-click-btn { width: 30px; height: 30px; border: 1px solid var(--peacock-green); color: var(--peacock-green); background: transparent; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-checked { background: var(--peacock-green); color: black; }
        .detail-btn, .cal-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #aaa; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .modal-content { max-width: 800px; margin: 0 auto; background: var(--container-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--peacock-green); color: var(--text-color); width: 100%; box-sizing: border-box; }
        .close-btn { float: right; font-size: 2rem; cursor: pointer; color: var(--mistake-red); }

        /* EXTRAS (Charts, Music, etc) */
        .charts-row { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .chart-wrapper { flex: 1; min-width: 300px; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; height: 300px; }
        #music-list { max-height: 300px; overflow-y: auto; }
        .music-btn { padding: 12px; margin-bottom: 5px; background: #222; border: 1px solid #444; color: #ddd; display: flex; justify-content: space-between; border-radius: 5px; cursor: pointer; }
        .music-playing { border-color: var(--peacock-green); color: var(--peacock-green); }
        
        /* MISTAKES */
        .mistake-controls { display: flex; flex-direction: column; gap: 10px; }
        .mistake-input, .mistake-select { padding: 10px; background: #222; border: 1px solid #555; color: white; border-radius: 5px; }
        .btn-add-mistake { background: var(--mistake-red); color: white; padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .mistake-item { background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; border-left: 3px solid #777; }

        /* RESULTS STAMPS */
        .result-stamp { border: 2px double; padding: 2px 8px; font-weight: bold; font-size: 1rem; transform: rotate(-5deg); display: inline-block; }
        .stamp-pass { color: var(--profit-green); border-color: var(--profit-green); }
        .stamp-fail { color: var(--mistake-red); border-color: var(--mistake-red); }
        .stamp-neutral { color: #555; border-color: #555; }
        
        /* CLOUD STATUS */
        #cloud-status { position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #aaa; z-index: 2000; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 10px; }

        /* ========================================= */
        /* üì± MOBILE RESPONSIVE MAGIC (THE FIX) */
        /* ========================================= */
        @media only screen and (max-width: 768px) {
            .container { padding: 15px; border: none; box-shadow: none; width: 100%; box-sizing: border-box; }
            
            /* Stack dashboard blocks 2x2 */
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            
            /* Schedule List: Time on top, Input below */
            .time-slot { padding: 12px 5px; align-items: flex-start; }
            .time-label { width: 100%; text-align: left; padding-bottom: 5px; font-size: 0.75rem; border-bottom: 1px solid #333; margin-bottom: 5px; }
            .cat-select { order: 1; }
            .task-input { order: 3; width: 100%; margin-top: 5px; border-bottom: 1px solid #555; }
            .action-group { order: 2; margin-left: auto; }
            
            /* Modals full width */
            .modal-content { width: 95%; padding: 15px; margin: 10px auto; }
            .stats-grid { grid-template-columns: 1fr 1fr; } /* Analysis stats */
            
            /* Buttons bigger for touch */
            .btn { padding: 10px; flex-grow: 1; text-align: center; }
            .top-controls { gap: 8px; }
            
            /* Font sizes */
            .user-name { font-size: 1rem; }
            .odia-quote { font-size: 1rem; }
            
            /* Hide Print button on mobile */
            .btn[onclick="window.print()"] { display: none; }
        }
    </style>
</head>
<body class="">

<div id="login-screen">
    <div id="login-box">
        <h2 style="color: var(--gold-accent); margin: 0 0 10px 0;">üîí COMMANDER ACCESS</h2>
        <input type="password" id="login-pass" class="login-input" placeholder="CODE">
        <button class="login-btn" onclick="checkLogin()">UNLOCK TERMINAL</button>
        <p id="login-msg" style="color: red; margin-top: 10px; height: 20px; font-size: 12px;"></p>
    </div>
</div>

<div id="cloud-status">‚òÅÔ∏è Connecting...</div>
<div id="trader-rank" class="rank-badge">üî∞ Novice</div>

<div id="mission-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('mission-modal').style.display='none'">√ó</span>
        <h2 style="color: var(--gold-accent); text-align: center;">üéØ MY MISSION</h2>
        <p style="text-align:center; color:#ddd;">"Life is a war and I am the king."</p>
        <div class="mission-section" style="border-left:3px solid var(--gold-accent); padding:10px; background:rgba(255,255,255,0.05); margin-bottom:10px;">
            <div style="color:var(--peacock-green); font-weight:bold;">GOALS</div>
            <p>1. Rule Follow = Non-negotiable<br>2. No Overtrading<br>3. Process > Profit</p>
        </div>
    </div>
</div>

<div id="calc-modal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <span class="close-btn" onclick="document.getElementById('calc-modal').style.display='none'">√ó</span>
        <h2 style="color: #3498db;">üßÆ Risk Calculator</h2>
        <div class="mistake-controls">
            <label>Capital</label><input type="number" id="calc-capital" class="mistake-input" placeholder="100000">
            <label>SL Points</label><input type="number" id="calc-sl" class="mistake-input" placeholder="20">
            <label>Risk %</label><input type="number" id="calc-risk" class="mistake-input" value="1">
            <button class="btn" style="background:#3498db; color:white; width:100%;" onclick="calculateRisk()">Calculate</button>
        </div>
        <div id="calc-result" style="text-align:center; margin-top:20px; font-size:1.5rem; color:white;"></div>
    </div>
</div>

<div id="music-modal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <span class="close-btn" onclick="stopAudio(); document.getElementById('music-modal').style.display='none'">√ó</span>
        <h2 style="color: #9966ff;">üéµ Music Focus</h2>
        <button class="btn" style="border-color:red; color:red; width:100%; margin-bottom:10px;" onclick="stopAudio()">üõë STOP AUDIO</button>
        <div id="music-list"></div>
    </div>
</div>

<div id="ritual-modal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <span class="close-btn" onclick="document.getElementById('ritual-modal').style.display='none'">√ó</span>
        <h2 style="color: #ff9f43;">üåÖ Rituals</h2>
        <div style="margin-bottom:10px;"><input type="checkbox"> Global Markets</div>
        <div style="margin-bottom:10px;"><input type="checkbox"> Key Levels</div>
        <div style="margin-bottom:10px;"><input type="checkbox"> No Mobile</div>
    </div>
</div>

<div id="slot-detail-modal" class="modal">
    <div class="modal-content" style="max-width:400px;">
        <span class="close-btn" onclick="document.getElementById('slot-detail-modal').style.display='none'">√ó</span>
        <h2 style="color: var(--gold-accent);">üìù Slot Detail</h2>
        <input type="hidden" id="slot-detail-id">
        <label>Device</label>
        <select id="slot-device" class="mistake-input" style="width:100%; margin-bottom:10px;"><option value="Laptop">Laptop</option><option value="Mobile">Mobile</option></select>
        <label>Location</label>
        <select id="slot-location" class="mistake-input" style="width:100%; margin-bottom:10px;"><option value="Home">Home</option><option value="Office">Office</option></select>
        <label>Mood</label>
        <select id="slot-mood" class="mistake-input" style="width:100%; margin-bottom:10px;"><option value="Calm">Calm</option><option value="Anxious">Anxious</option></select>
        <button class="btn" style="background:var(--gold-accent); color:black; width:100%;" onclick="saveSlotDetail()">Save</button>
    </div>
</div>

<div id="analysis-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('analysis-modal').style.display='none'">√ó</span>
        <h2 style="color: var(--peacock-green);">üìä War Room</h2>
        <div class="charts-row">
            <div class="chart-wrapper"><canvas id="moodDoughnutChart"></canvas></div>
            <div class="chart-wrapper"><canvas id="screenTimeChart"></canvas></div>
        </div>
        <div id="yearly-heatmap" style="display:flex; flex-wrap:wrap; gap:2px; margin-top:20px; justify-content:center;"></div>
    </div>
</div>

<div class="container">
    <header>
        <div class="user-name">üë§ Commander: Daimond</div>
        <div class="odia-quote">‡¨Ø‡≠Å‡¨¶‡≠ç‡¨ß‡¨∞ ‡¨∞‡¨æ‡¨ú‡¨æ ‡¨Æ‡≠Å‡¨Å</div>
    </header>

    <div class="top-controls">
        <div class="date-nav">
            <button class="btn" onclick="changeDate(-1)">‚ùÆ</button>
            <input type="date" id="date-picker" onchange="loadDate(this.value)">
            <button class="btn" onclick="changeDate(1)">‚ùØ</button>
        </div>
        <button class="btn" onclick="document.getElementById('mission-modal').style.display='block'">üéØ Mission</button>
        <button class="btn" onclick="document.getElementById('music-modal').style.display='block'">üéµ Music</button>
        <button class="btn" onclick="document.getElementById('ritual-modal').style.display='block'">üåÖ Ritual</button>
        <button class="btn" onclick="document.getElementById('calc-modal').style.display='block'">üßÆ Calc</button>
        <button class="btn" onclick="runDetailedAnalysis()">üìä Stats</button>
        <button class="btn" onclick="init()">üîÑ Sync</button>
        <button class="btn" id="theme-btn" onclick="cycleTheme()">üé® Theme</button>
        <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
    </div>

    <div class="dashboard-grid">
        <div class="score-board">
            <div class="score-label">Result</div>
            <div id="day-result-badge" class="result-stamp stamp-neutral">N/A</div>
        </div>
        <div class="score-board">
            <div class="score-label">Score</div>
            <div id="daily-score" class="score-val">0%</div>
            <div class="score-label" id="task-count">0/0</div>
        </div>
        <div class="brahmacharya-board" id="brahmacharya-box">
            <div class="streak-val" id="brahmacharya-streak" style="font-size:1.5rem;">0</div>
            <div class="score-label">Brahmacharya</div>
            <div id="brahmacharya-actions" style="margin-top:5px;">
                <button class="btn" style="color:var(--peacock-green); padding:2px 8px;" onclick="confirmBrahmacharya(true)">Yes</button>
                <button class="btn" style="color:red; padding:2px 8px;" onclick="confirmBrahmacharya(false)">No</button>
            </div>
            <div id="brahmacharya-status" style="display:none; color:var(--peacock-green);">Pure</div>
        </div>
        <div class="pnl-board">
            <div class="score-label">P&L (‚Çπ)</div>
            <input type="number" id="daily-pnl" class="pnl-input" placeholder="0" onchange="savePnL()">
            <select id="daily-mindset" class="mindset-select" onchange="savePnL()">
                <option value="">Mindset?</option>
                <option value="calm">üßò Calm</option>
                <option value="fomo">üò® FOMO (FAIL)</option>
                <option value="greed">ü§ë Greed (FAIL)</option>
                <option value="revenge">üò° Revenge (FAIL)</option>
            </select>
        </div>
    </div>

    <div id="schedule-container" class="schedule-grid"></div>

    <div class="reflections" style="border-top:1px solid #444; margin-top:20px;">
        <div class="reflection-box full-width">
            <span style="color:var(--mistake-red); font-weight:bold;">‚ö†Ô∏è Mistakes Log</span>
            <div class="mistake-controls">
                <input type="text" id="mistake-desc" class="mistake-input" placeholder="Description...">
                <select id="mistake-severity" class="mistake-select"><option value="critical">üî¥ Critical</option><option value="minor">üü° Minor</option></select>
                <button class="btn-add-mistake" onclick="addMistake()">Add</button>
            </div>
            <div id="mistake-list"></div>
        </div>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG (YOUR KEY) ---
    var firebaseConfig = {
        apiKey: "AIzaSyCLD87imksmqI2uENX4PVRDcnun3WxTdbk",
        authDomain: "mera-personal-data.firebaseapp.com",
        databaseURL: "https://mera-personal-data-default-rtdb.firebaseio.com",
        projectId: "mera-personal-data",
        storageBucket: "mera-personal-data.firebasestorage.app",
        messagingSenderId: "304579476606",
        appId: "1:304579476606:web:8fa78fee9cbe2f301f2c2f"
    };

    // --- LOGIN ---
    function checkLogin() {
        if(document.getElementById('login-pass').value === "1234") {
            document.getElementById('login-screen').style.display = 'none';
        } else { document.getElementById('login-msg').innerText = "INVALID CODE"; }
    }

    // --- AUDIO ENGINE ---
    let audioContext = null; let activeOscillators = [];
    const PRESETS = [
        {name: "üïâÔ∏è Om (136.1Hz)", freq: 136.1}, {name: "‚ú® Miracle (528Hz)", freq: 528}, 
        {name: "üß† Alpha (Focus)", freq: 432}, {name: "üü§ Brown Noise", type: 'noise'}
    ];
    function initAudio() { if(!audioContext) audioContext = new (window.AudioContext||window.webkitAudioContext)(); }
    function stopAudio() { 
        activeOscillators.forEach(o=>{try{o.stop()}catch(e){}; try{o.disconnect()}catch(e){}}); 
        activeOscillators=[]; document.querySelectorAll('.music-btn').forEach(b=>b.classList.remove('music-playing'));
    }
    function playTone(idx) {
        initAudio(); stopAudio(); const p = PRESETS[idx];
        const g = audioContext.createGain(); g.gain.value = 0.1; g.connect(audioContext.destination);
        if(p.type==='noise'){
            const b = audioContext.createBuffer(1, audioContext.sampleRate*2, audioContext.sampleRate);
            const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.5;
            const src = audioContext.createBufferSource(); src.buffer=b; src.loop=true; src.connect(g); src.start(); activeOscillators.push(src);
        } else {
            const o = audioContext.createOscillator(); o.frequency.value = p.freq; o.connect(g); o.start(); activeOscillators.push(o);
        }
    }
    function renderMusicList() {
        const l = document.getElementById('music-list'); l.innerHTML='';
        PRESETS.forEach((p,i)=>{
            const b = document.createElement('div'); b.className='music-btn'; b.innerHTML=`<span>${p.name}</span><span>‚ñ∂Ô∏è</span>`;
            b.onclick=()=>{document.querySelectorAll('.music-btn').forEach(x=>x.classList.remove('music-playing')); b.classList.add('music-playing'); playTone(i);};
            l.appendChild(b);
        });
    }

    // --- APP LOGIC ---
    let dbRef; let isCloudActive = false; let currentDate = new Date(); window.divineCharts={};
    const categories = { 'work': {emoji:'üíº'}, 'study':{emoji:'üìö'}, 'health':{emoji:'üí™'}, 'spiritual':{emoji:'üïâÔ∏è'} };
    const themes = ['', 'theme-warzone', 'theme-matrix', 'theme-zen']; let curThm=0;

    function initFirebase() {
        if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        dbRef = firebase.database().ref('divine_planner_data');
        document.getElementById('cloud-status').innerText = "‚òÅÔ∏è OK"; document.getElementById('cloud-status').style.color="#00ffcc";

        const originalSetItem = localStorage.setItem;
        localStorage.setItem = function(k, v) { originalSetItem.apply(this, arguments); if(isCloudActive) dbRef.child(k).set(v); };
        const originalRemoveItem = localStorage.removeItem;
        localStorage.removeItem = function(k) { originalRemoveItem.apply(this, arguments); if(isCloudActive) dbRef.child(k).remove(); };

        dbRef.once('value', (s) => {
            const d = s.val(); if(d) Object.keys(d).forEach(k => originalSetItem.call(localStorage, k, d[k]));
            isCloudActive = true; init();
        });
    }

    function init() {
        const t = localStorage.getItem('divine_theme_idx'); if(t) curThm=parseInt(t); applyTheme();
        document.getElementById('date-picker').value = formatDateKey(currentDate);
        renderMusicList(); refreshView(); updateBrahmacharyaUI();
    }
    function cycleTheme() { curThm=(curThm+1)%themes.length; localStorage.setItem('divine_theme_idx',curThm); applyTheme(); }
    function applyTheme() { document.body.className = themes[curThm]; }

    function formatDateKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function changeDate(d) { currentDate.setDate(currentDate.getDate()+d); document.getElementById('date-picker').value=formatDateKey(currentDate); refreshView(); updateBrahmacharyaUI(); }
    function loadDate(d) { if(!d)return; currentDate=new Date(d); refreshView(); updateBrahmacharyaUI(); }
    function refreshView() { renderSchedule(); renderMistakes(); loadPnL(); calculateScore(); }

    function renderSchedule() {
        const c = document.getElementById('schedule-container'); c.innerHTML = ''; const dk = formatDateKey(currentDate);
        for(let t=0; t<24*60; t+=30) {
            let h=Math.floor(t/60), m=t%60; let ts = `${h%12||12}:${m<10?'0'+m:m} ${h>=12?'PM':'AM'}`;
            let sid=`task_${dk}_${h}-${m}`, cid=`check_${dk}_${h}-${m}`, catid=`cat_${dk}_${h}-${m}`;
            
            const r = document.createElement('div'); r.className='time-slot';
            const chk = document.createElement('input'); chk.type='checkbox'; chk.id=cid; chk.checked=localStorage.getItem(cid)==='true';
            
            const sel = document.createElement('select'); sel.className='cat-select';
            for(const[k,v] of Object.entries(categories)) { const o=document.createElement('option'); o.value=k; o.textContent=v.emoji; sel.appendChild(o); }
            sel.value = localStorage.getItem(catid) || 'work'; sel.onchange=(e)=>localStorage.setItem(catid, e.target.value);

            const inp = document.createElement('input'); inp.type='text'; inp.className='task-input '+(chk.checked?'task-done':''); inp.value=localStorage.getItem(sid)||'';
            inp.oninput=(e)=>{localStorage.setItem(sid,e.target.value); calculateScore();};

            const acts = document.createElement('div'); acts.className='action-group';
            const btnD = document.createElement('button'); btnD.className='detail-btn'; btnD.innerHTML='üìù'; btnD.onclick=()=>openDetail(h,m);
            const btnC = document.createElement('button'); btnC.className='done-click-btn '+(chk.checked?'btn-checked':''); btnC.innerHTML=chk.checked?'‚úì':'';
            btnC.onclick=()=>{ chk.checked=!chk.checked; localStorage.setItem(cid, chk.checked); refreshView(); };
            
            acts.append(btnD, btnC); r.append(createEl('div','time-label',ts), sel, acts, inp); c.appendChild(r);
        }
    }
    function createEl(tag,cls,txt){const e=document.createElement(tag);e.className=cls;e.textContent=txt;return e;}

    function openDetail(h,m) {
        document.getElementById('slot-detail-id').value = `detail_${formatDateKey(currentDate)}_${h}-${m}`;
        document.getElementById('slot-detail-modal').style.display='block';
    }
    function saveSlotDetail() {
        const k = document.getElementById('slot-detail-id').value;
        const d = {dev:document.getElementById('slot-device').value, loc:document.getElementById('slot-location').value};
        localStorage.setItem(k, JSON.stringify(d)); document.getElementById('slot-detail-modal').style.display='none';
    }

    function calculateScore(){
        const dk = formatDateKey(currentDate); let t=0, c=0;
        for(let i=0; i<24*60; i+=30){ let h=Math.floor(i/60), m=i%60; if(localStorage.getItem(`task_${dk}_${h}-${m}`)?.trim()) { t++; if(localStorage.getItem(`check_${dk}_${h}-${m}`)==='true') c++; } }
        const sc = t ? Math.round((c/t)*100) : 0;
        document.getElementById('daily-score').textContent = sc+"%"; document.getElementById('task-count').textContent = `${c}/${t}`;
        
        const badge = document.getElementById('day-result-badge'); const ms = JSON.parse(localStorage.getItem(getMistakeKey())||"[]");
        let res = "PASS"; if(ms.some(m=>m.sev==='critical') || ['fomo','revenge'].includes(document.getElementById('daily-mindset').value)) res="FAIL";
        else if(t===0 && !document.getElementById('daily-pnl').value) res="N/A";
        badge.innerText=res; badge.className = `result-stamp ${res==='PASS'?'stamp-pass':res==='FAIL'?'stamp-fail':'stamp-neutral'}`;
    }

    function savePnL(){ const k=formatDateKey(currentDate); localStorage.setItem('pnl_'+k, document.getElementById('daily-pnl').value); localStorage.setItem('mindset_'+k, document.getElementById('daily-mindset').value); calculateScore(); }
    function loadPnL(){ const k=formatDateKey(currentDate); document.getElementById('daily-pnl').value=localStorage.getItem('pnl_'+k)||''; document.getElementById('daily-mindset').value=localStorage.getItem('mindset_'+k)||''; }

    function getMistakeKey(){return 'mistakes_'+formatDateKey(currentDate);}
    function addMistake(){
        const k=getMistakeKey(); const l=JSON.parse(localStorage.getItem(k)||"[]");
        l.push({id:Date.now(), sev:document.getElementById('mistake-severity').value, desc:document.getElementById('mistake-desc').value});
        localStorage.setItem(k, JSON.stringify(l)); renderMistakes(); calculateScore();
    }
    function renderMistakes(){
        const l=document.getElementById('mistake-list'); l.innerHTML='';
        JSON.parse(localStorage.getItem(getMistakeKey())||"[]").forEach(m=>{
            const d=document.createElement('div'); d.className='mistake-item';
            d.innerHTML=`<span>${m.desc}</span> <button class="btn" style="color:red" onclick="delMistake(${m.id})">√ó</button>`; l.appendChild(d);
        });
    }
    function delMistake(id){ const k=getMistakeKey(); const l=JSON.parse(localStorage.getItem(k)||"[]").filter(m=>m.id!==id); localStorage.setItem(k, JSON.stringify(l)); renderMistakes(); calculateScore(); }

    function updateBrahmacharyaUI() {
        const start = localStorage.getItem('brahmacharya_start'); let streak = 0; if(start) streak = Math.floor((new Date() - new Date(start))/(1000*60*60*24));
        document.getElementById('brahmacharya-streak').textContent = streak;
        const chk = localStorage.getItem('brahmacharya_check_'+formatDateKey(currentDate)); const st = document.getElementById('brahmacharya-status');
        if(chk==='yes') { st.style.display='block'; st.innerText="Pure"; st.style.color="#00ffcc"; } else if(chk==='no') { st.style.display='block'; st.innerText="Relapsed"; st.style.color="red"; } else { st.style.display='none'; }
    }
    function confirmBrahmacharya(success) {
        const k = formatDateKey(currentDate);
        if(success) { localStorage.setItem('brahmacharya_check_'+k, 'yes'); if(!localStorage.getItem('brahmacharya_start')) localStorage.setItem('brahmacharya_start', new Date().toISOString()); } 
        else { if(!confirm("Reset?")) return; localStorage.setItem('brahmacharya_check_'+k, 'no'); localStorage.setItem('brahmacharya_start', new Date().toISOString()); }
        updateBrahmacharyaUI();
    }

    function calculateRisk() {
        const c=parseFloat(document.getElementById('calc-capital').value), sl=parseFloat(document.getElementById('calc-sl').value), r=parseFloat(document.getElementById('calc-risk').value);
        if(c&&sl&&r) document.getElementById('calc-result').innerHTML = `Qty: <span style="color:#00ffcc">${Math.floor((c*r/100)/sl)}</span>`;
    }

    function runDetailedAnalysis() {
        document.getElementById('analysis-modal').style.display='block';
        setTimeout(()=>{
            if(window.divineCharts['mood']) window.divineCharts['mood'].destroy();
            window.divineCharts['mood']=new Chart(document.getElementById('moodDoughnutChart'),{type:'doughnut',data:{labels:['Calm','Stress'],datasets:[{data:[80,20],backgroundColor:['#4bc0c0','#ff6b6b']}]}});
            
            const h=document.getElementById('yearly-heatmap'); h.innerHTML='';
            for(let i=100; i>=0; i--){
                const d=new Date(); d.setDate(d.getDate()-i); const s=parseInt(localStorage.getItem(`score_${formatDateKey(d)}`)||0);
                const b=document.createElement('div'); b.style.width='10px'; b.style.height='10px'; b.style.background=s>0?`rgba(0,255,204,${s/100})`:'rgba(255,255,255,0.1)'; h.appendChild(b);
            }
        },100);
    }

    initFirebase();
</script>
</body>
</html>